name: Run Student Scraper

on:
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * *'

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Scraper Script
        run: python scraper.py

      - name: Get file info
        id: file_info
        run: |
          if [ -f "results.xlsx" ]; then
            file_size=$(du -h results.xlsx | cut -f1)
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "file_size=$file_size" >> $GITHUB_OUTPUT
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Send results to Telegram
        if: steps.file_info.outputs.file_exists == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          document: results.xlsx
          caption: |
            ğŸ“Š *Student Scraper Results*
            
            *ğŸ“… Date:* $(date +'%Y-%m-%d %H:%M')
            *ğŸ“ File:* results.xlsx
            *ğŸ’¾ Size:* ${{ steps.file_info.outputs.file_size }}
            *ğŸ”— Run:* [${{ github.repository }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            _File attached successfully!_

      - name: Notify if no file
        if: steps.file_info.outputs.file_exists == 'false'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            âŒ *Scraper Failed*
            
            No results file was generated!
            
            *Repository:* ${{ github.repository }}
            *Run ID:* ${{ github.run_id }}
            *Time:* $(date +'%Y-%m-%d %H:%M')
            
            Please check the workflow logs.
